name: Build FreeType

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, Win32]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup and Install vcpkg dependencies
      run: |
        git clone https://github.com/microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat
        $vcpkgTriplet = if ("${{ matrix.arch }}" -eq "x64") { "x64-windows-static" } else { "x86-windows-static" }
        .\vcpkg\vcpkg install zlib:$vcpkgTriplet bzip2:$vcpkgTriplet libpng:$vcpkgTriplet brotli:$vcpkgTriplet
        .\vcpkg\vcpkg list
        # Persist VCPKG_ROOT for subsequent steps
        "VCPKG_ROOT=${{ github.workspace }}\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: ${{ matrix.arch }}
    
    - name: Verify vcpkg installation
      run: |
        $vcpkgTriplet = if ("${{ matrix.arch }}" -eq "x64") { "x64-windows-static" } else { "x86-windows-static" }
        Write-Host "Checking vcpkg installed packages..."
        Get-ChildItem "${{ github.workspace }}\vcpkg\installed\$vcpkgTriplet" -ErrorAction SilentlyContinue
        Write-Host "`nChecking for lib files..."
        Get-ChildItem "${{ github.workspace }}\vcpkg\installed\$vcpkgTriplet\lib" -ErrorAction SilentlyContinue
        Write-Host "`nChecking for include files..."
        Get-ChildItem "${{ github.workspace }}\vcpkg\installed\$vcpkgTriplet\include" -ErrorAction SilentlyContinue
    
    - name: Configure CMake
      env:
        VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        CC: cl
        CXX: cl
      run: |
        $vcpkgTriplet = if ("${{ matrix.arch }}" -eq "x64") { "x64-windows-static" } else { "x86-windows-static" }
        $vcpkgRoot = "${{ github.workspace }}\vcpkg"
        $toolchainFile = "$vcpkgRoot\scripts\buildsystems\vcpkg.cmake"
        Write-Host "Using VCPKG_ROOT: $env:VCPKG_ROOT"
        Write-Host "Using toolchain: $toolchainFile"
        Write-Host "Using triplet: $vcpkgTriplet"
        cmake -B build -G Ninja `
          -DCMAKE_C_COMPILER=cl `
          -DCMAKE_CXX_COMPILER=cl `
          -DCMAKE_TOOLCHAIN_FILE="$toolchainFile" `
          -DVCPKG_TARGET_TRIPLET=$vcpkgTriplet `
          -DBUILD_SHARED_LIBS=ON `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded `
          -DFT_REQUIRE_ZLIB=TRUE `
          -DFT_REQUIRE_BZIP2=TRUE `
          -DFT_REQUIRE_PNG=TRUE `
          -DFT_REQUIRE_BROTLI=TRUE `
          -DFT_DISABLE_HARFBUZZ=TRUE
    
    - name: Build
      run: cmake --build build
    
    - name: Verify DLL dependencies
      run: |
        Write-Host "Checking DLL dependencies..."
        dumpbin /DEPENDENTS build\freetype.dll
        Write-Host "`nChecking for static runtime linkage..."
        dumpbin /DIRECTIVES build\freetype.dll | Select-String -Pattern "DEFAULTLIB"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: freetype-windows-${{ matrix.arch }}
        path: |
          build/*.dll
          build/*.lib
          build/include/freetype/config/*.h
        if-no-files-found: error

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential pkg-config
    
    - name: Build static dependencies
      run: |
        mkdir -p deps
        cd deps
        
        # Build zlib
        wget https://zlib.net/zlib-1.3.1.tar.gz
        tar xzf zlib-1.3.1.tar.gz
        cd zlib-1.3.1
        ./configure --prefix=$PWD/../../build-deps --static
        make -j$(nproc)
        make install
        cd ..
        
        # Build bzip2
        wget https://sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz
        tar xzf bzip2-1.0.8.tar.gz
        cd bzip2-1.0.8
        make -j$(nproc) CFLAGS="-fPIC -O2"
        make install PREFIX=$PWD/../../build-deps
        cd ..
        
        # Build libpng (needs zlib)
        wget https://download.sourceforge.net/libpng/libpng-1.6.40.tar.gz
        tar xzf libpng-1.6.40.tar.gz
        cd libpng-1.6.40
        ./configure --prefix=$PWD/../../build-deps --enable-shared=no --enable-static=yes \
          CFLAGS="-I$PWD/../../build-deps/include" LDFLAGS="-L$PWD/../../build-deps/lib"
        make -j$(nproc)
        make install
        cd ..
        
        # Build brotli
        git clone --depth 1 --branch v1.1.0 https://github.com/google/brotli.git
        cd brotli
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=$PWD/../../../build-deps \
          -DBUILD_SHARED_LIBS=OFF \
          -DCMAKE_POSITION_INDEPENDENT_CODE=ON
        make -j$(nproc)
        make install
        cd ../..
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -D CMAKE_BUILD_TYPE=Release \
          -D BUILD_SHARED_LIBS=ON \
          -D CMAKE_PREFIX_PATH=$PWD/build-deps \
          -D FT_REQUIRE_ZLIB=TRUE \
          -D FT_REQUIRE_BZIP2=TRUE \
          -D FT_REQUIRE_PNG=TRUE \
          -D FT_REQUIRE_BROTLI=TRUE \
          -D FT_DISABLE_HARFBUZZ=TRUE \
          -D CMAKE_EXE_LINKER_FLAGS="-static-libgcc -static-libstdc++"
    
    - name: Build
      run: cmake --build build
    
    - name: Verify SO dependencies
      run: |
        echo "Checking shared library dependencies..."
        ldd build/libfreetype.so.6 || true
        echo -e "\nChecking for statically linked symbols..."
        nm -D build/libfreetype.so.6 | grep -E "zlib|bzip2|png|brotli" | head -20 || true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: freetype-linux-x64
        path: |
          build/libfreetype.so*
          build/include/freetype/config/*.h
        if-no-files-found: error

  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          freetype-windows-x64/*
          freetype-windows-Win32/*
          freetype-linux-x64/*
